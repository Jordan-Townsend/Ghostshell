<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ghostshell MMO â€“ Full Client</title>
  <style>
    body { background-color: black; color: lime; font-family: monospace; padding: 2em; }
    input, button { font-family: monospace; background: black; color: lime; border: 1px solid lime; padding: 0.4em; }
    #log { max-height: 300px; overflow-y: scroll; border: 1px solid lime; background: #111; padding: 1em; margin-top: 1em; }
    .creator-panel, .xr-panel, .login-panel { border: 1px dashed cyan; padding: 1em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>ğŸŒŒ Ghostshell MMO Portal</h1>

  <div class="login-panel">
    <label>Username: <input id="username" /></label><br>
    <label>Password: <input id="password" type="password" /></label><br>
    <button onclick="startSession()">Start Session</button>
  </div>

  <div id="log"></div>
  <input id="messageInput" placeholder="Cast symbolic action..." size="50" />
  <button onclick="sendMessage()">Send</button>
  <button onclick="exportLog()">ğŸ“¥ Export Log</button>

  <div id="creatorPanel" class="creator-panel" style="display:none;">
    <h2>ğŸ‘ Creator Tools</h2>
    <button onclick="sendMessage('system_ping')">Ping All</button>
    <button onclick="sendMessage('inject_overlay')">Inject Overlay</button>
  </div>

  <div id="xrPanel" class="xr-panel" style="display:none;">
    <h2>ğŸ•¶ Immersive Mode</h2>
    <p>WebXR connection established.</p>
  </div>

  <script>
    let nickname = "";
    let symbolicLog = [];
    let socket;

    function startSession() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      if (!user || !pass) {
        alert("Username and password required.");
        return;
      }

      localStorage.setItem("ghostshell_user", user);
      localStorage.setItem("ghostshell_pass", pass);
      nickname = user;

      if (pass === "symbolic42") {
        document.getElementById("creatorPanel").style.display = "block";
      }

      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get("mode") || "2d";
      if (mode === "vr" || mode === "ar") {
        document.getElementById("xrPanel").style.display = "block";
      }

      connectWebSocket();
    }

    function connectWebSocket() {
      const wsURL = "wss://" + window.location.hostname + "/ws";
      appendLog("ğŸ”Œ Connecting to: " + wsURL);
      socket = new WebSocket(wsURL);

      socket.onopen = () => {
        appendLog("ğŸŸ¢ Connected as " + nickname);
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const msg = `ğŸ’¬ ${data.nickname}: ${data.message}`;
          appendLog(msg);
          symbolicLog.push(msg);
        } catch {
          appendLog("âš ï¸ Invalid message.");
        }
      };

      socket.onerror = () => {
        appendLog("âŒ Connection error.");
      };
    }

    function sendMessage(customMessage) {
      const input = document.getElementById("messageInput");
      const message = customMessage || input.value.trim();
      if (!message) return;
      const payload = { nickname: nickname, message: message };
      socket.send(JSON.stringify(payload));
      appendLog("ğŸ—£ " + message);
      symbolicLog.push(`ğŸ—£ ${message}`);
      input.value = "";
    }

    function appendLog(text) {
      const div = document.createElement("div");
      div.innerText = text;
      document.getElementById("log").appendChild(div);
      document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
    }

    function exportLog() {
      const logBlob = new Blob([symbolicLog.join("\n")], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(logBlob);
      link.download = "symbolic_log.txt";
      link.click();
    }

    // Auto-fill login from previous session
    window.onload = () => {
      const savedUser = localStorage.getItem("ghostshell_user");
      const savedPass = localStorage.getItem("ghostshell_pass");
      if (savedUser && savedPass) {
        document.getElementById("username").value = savedUser;
        document.getElementById("password").value = savedPass;
        startSession();
      }
    };
  </script>
</body>
</html>
